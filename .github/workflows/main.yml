name: Ubuntu 20.04 + Tailscale + SSH (A)

on:
  workflow_dispatch:
    inputs:
      ts_tailnet:         { description: "Tailscale tailnet (e.g. you@gmail.com)", required: true }
      ts_api_key:         { description: "Tailscale API key (device admin, no Bearer)", required: true }
      ts_authkey:         { description: "Tailscale Auth key", required: true }
      runtime_minutes:    { description: "Runtime (max 360)", required: false, default: "355" }
      do_purge:           { description: "Purge bullet* devices", required: false, default: "true" }
      cycles:             { description: "0=stop; N=handoffs left", required: false, default: "0" }
      instance_count:     { description: "How many instances (1-5)", required: false, default: "1" }

permissions:
  contents: read
  actions: write

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.mk.outputs.matrix }}
      multi:  ${{ steps.mk.outputs.multi }}
    steps:
      - id: mk
        run: |
          n=${{ inputs.instance_count }}
          if [ "$n" -lt 1 ]; then n=1; fi
          if [ "$n" -gt 5 ]; then n=5; fi
          echo "matrix={\"include\":[$(for i in $(seq 1 $n); do echo -n "{\"id\":$i},"; done | sed 's/,$//')]} " >> $GITHUB_OUTPUT
          if [ "$n" -gt 1 ]; then echo "multi=1" >> $GITHUB_OUTPUT; else echo "multi=0" >> $GITHUB_OUTPUT; fi

  ubuntu:
    needs: setup
    runs-on: ubuntu-20.04
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
      max-parallel: 5
    timeout-minutes: 360

    steps:

      - name: Decide hostname + runtime
        run: |
          if [ "${{ inputs.instance_count }}" -gt 1 ]; then
            HOST="bullet${{ matrix.id }}"
          else
            HOST="bullet"
          fi
          echo "HOSTNAME=$HOST" >> $GITHUB_ENV

          RUNTIME=${{ inputs.runtime_minutes }}
          if [ "$RUNTIME" -gt 360 ]; then RUNTIME=355; fi
          echo "RUNTIME=$RUNTIME" >> $GITHUB_ENV

      - name: Purge bullet devices (single only)
        if: ${{ needs.setup.outputs.multi == '0' }}
        run: |
          if [ "${{ inputs.do_purge }}" = "true" ]; then
            AUTH=$(echo -n "${{ inputs.ts_api_key }}:" | base64)
            curl -s -H "Authorization: Basic $AUTH" \
            https://api.tailscale.com/api/v2/tailnet/${{ inputs.ts_tailnet }}/devices \
            | jq -r '.devices[] | select(.hostname | test("^bullet[0-9]*$")) | .id' \
            | while read id; do
                curl -X DELETE -H "Authorization: Basic $AUTH" \
                https://api.tailscale.com/api/v2/device/$id
              done
          fi

      - name: Install SSH + Tools
        run: |
          sudo apt update
          sudo apt install -y openssh-server curl jq
          sudo useradd -m bullet
          echo "bullet:Bullet@12345" | sudo chpasswd
          sudo usermod -aG sudo bullet
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ inputs.ts_authkey }} --hostname=$HOSTNAME
          tailscale ip -4

      - name: Keep Alive
        run: |
          END=$((SECONDS + RUNTIME*60))
          while [ $SECONDS -lt $END ]; do
            echo "Ubuntu 20.04 running on $HOSTNAME..."
            sleep 60
          done

      - name: Dispatch next or stop
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CYC=${{ inputs.cycles }}
          if [ "$CYC" -gt 0 ]; then
            NEXT=$((CYC-1))
            curl -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/ubuntu.yml/dispatches \
              -d "{\"ref\":\"${{ github.ref_name }}\",\"inputs\":{\"ts_tailnet\":\"${{ inputs.ts_tailnet }}\",\"ts_api_key\":\"${{ inputs.ts_api_key }}\",\"ts_authkey\":\"${{ inputs.ts_authkey }}\",\"cycles\":\"$NEXT\"}}"
          fi
